---
title: "fishbase"
author: "Han lab"
date: "8/3/2020"
output: github_document
---

#####install packages
```{r packages, echo=FALSE}
pkgTest <- function(x)
{
  if (x %in% rownames(installed.packages()) == FALSE) {
    install.packages(x, dependencies= TRUE)    
  }
  library(x, character.only = TRUE)
}
neededPackages <- c( "ggplot2", "rentrez", "plyr", "seqinr", "foreach","broom", "remotes", "Biostrings", "stringr", "phylotools", "data.table", "rfishbase", "Hmisc", "caret", "tidyr", "ggforce", "broom", "gbm", "caret", "Matrix", "pdp", "caTools", "ROCR", "dplyr", "dismo", "doSNOW", "data.table", "rsample", "tidyverse", "sf", "raster", "mapview", "rnaturalearth", "fasterize", "tidyr", "patchwork", "gtable", "magrittr",  "fulltext")
for (package in neededPackages){pkgTest(package)}
```

##function to take the same across rows of categorical variables that have been 1/0 encoded, where a species may have 1 for more than one condition of a variable
```{r sum_or_mean, include = FALSE}
source("R_function_sum_or_mean.R")
```

##function to replace NAs with real values for binary fields
```{r keep_real_binary, include = FALSE}
source("R_function_keep_real_binary.R")
```

```{r non_biological_list, include = FALSE}
source("non_biological.R")
```


```{r process_table, include = FALSE}
source("R_function_process_table.R")
```


##settings
```{r cutoff, include = FALSE}
cutoff = 0.15#cutoff of coverage required for inclusion
```


##look at docs about tables available from fishbase
```{r tables, include = FALSE}
tables <- docs()
tables
```


##read in data and fix species names
```{r haddock_data, include = FALSE}
DF = read.csv("docking-results.csv")

DF$species = str_replace(DF$species, pattern = "_", replacement = " ")

DF$species=capitalize(DF$species)

A = read.csv("ACE2_sequences_fixed.csv")
A_fish = subset(A, is_fish == 1)

names(DF)[names(DF)=="species"]="Species"

DF = DF[, c("Species", "haddock_score_mean", "haddock_score_sd")]
A_fish = A_fish[,c("Species", "Order", "Class")]

DF = merge(DF, A_fish)

#https://cran.r-project.org/web/packages/rfishbase/vignettes/tutorial.html
fish <- validate_names(c(DF$Species))

DF$Species_ACE2 = DF$Species
DF$Species = fish
save(DF, file = "DF.Rdata")
```

##distribution
##currently this is ~ FAO areas table (minus "note" field) e.g. http://www.fishbase.us/Country/FaoAreaList.php?ID=5537
##each species may have multiple bounding boxes
```{r, include = FALSE}
load("DF.Rdata")
species = DF$Species
out = NULL
for (a in 1:length(species)){
  tmp = data.frame(distribution(species[a]))
  print(dim(tmp)[1])
  
  ind_species =which(names(tmp) == "Species")
  inds_new = setdiff(seq(1,dim(tmp)[2]), ind_species)
  names(tmp)[inds_new]= paste0(names(tmp)[inds_new], 
                                       "_distribution")
  tmp = merge(DF[a,], tmp)
  out = rbind(out, tmp)
}

DF_distribution = out
save(DF_distribution, file = "DF_distribution_simple.Rdata")
load("DF_distribution_simple.Rdata")

DF = DF_distribution
str_which(names(DF), "Sub")#doesn't include subarea
test = subset(DF_distribution, Species == "Acanthochromis polyacanthus")
test$FAO_distribution

FAO <- st_read("FAO_AREAS/Marine/FAO_AREAS.shp")
FAO_test= subset(FAO, NAME_EN == "Indian Ocean, Eastern")
plot(FAO_test)

keep = c("NorthernLatitude_distribution" ,  "NorthernLatitudeNS_distribution" ,"SouthernLatitude_distribution"  ,
 "SouthernLatitudeNS_distribution", "WesternLongitude_distribution" ,  "WesternLongitudeEW_distribution"
, "EasternLongitude_distribution" ,  "EasternLongitudeEW_distribution")
keep = c(keep, "Species", "FAO_distribution")
test = test[, keep]

#looked at map and figured out that bounding box encompasses FAO area

```

```{r, include = FALSE}
load("DF_distribution_simple.Rdata")
DATA <- DF_distribution
```

Read in the FAO areas (from http://www.fao.org/geonetwork/srv/en/main.home?uuid=ac02a460-da52-11dc-9d70-0017f293bd28 as described by http://www.fishbase.us/manual/English/FishbaseThe_FAOAREAS_Table.htm). It looks like our data contain both the inland and marine FAOs, so I read in both and combined them according to a single column of FAO code.
```{r, include = FALSE}
load("DF.Rdata")
FAO <- st_read("FAO_AREAS/Marine/FAO_AREAS.shp")
FAO$area <- st_area(FAO)

FAO=data.frame(F_CODE = FAO$F_CODE,
               area = FAO$area)

test = FAO[1,]

arctic_tmp = subset(DATA, AreaCode_distribution == test$F_CODE)#this checks out
print(arctic_tmp$FAO_distribution)

names(DATA)[names(DATA)=="AreaCode_distribution"]="F_CODE"
DATA$F_CODE = as.character(DATA$F_CODE)

#inland waters
IFAO <- st_read("FAO_AREAS/Inland/FAO_AREAS_INLAND.shp")
IFAO$F_AREA_INL <- gsub("0", "", IFAO$F_AREA_INL)
names(IFAO)[names(IFAO)=="F_AREA_INL"]="F_CODE"
IFAO$area = st_area(IFAO)

IFAO = data.frame(F_CODE = IFAO$F_CODE,
                  area = IFAO$area)

FAO = rbind(FAO, IFAO)

species = unique(DF$Species)
a = 1
area = rep(NA, length(species))
for (a in 1:length(species)){
  DATA_tmp = subset(DATA, Species == species[a])
  FAO_tmp = subset(FAO, F_CODE %in% as.character(DATA_tmp$F_CODE))
  area[a] = sum(FAO_tmp$area, na.rm = TRUE)
}

area = area * 0.000001#convert to sq km
dist = data.frame(Species = species,
                  range_area = area)
save(dist, file = "dist.Rdata")
#convert to km2
load("dist.Rdata")
```

##check out some tables in fishbase
##brains: one entry for each individual fish: BrainWeight, BodyWeight
##https://www.fishbase.in/manual/fishbasethe_brains_table.htm
```{r brains, include = FALSE}
load("DF.Rdata")
load("dist.Rdata")
T = brains()
load("process_table.Rdata")
load("non_biological.Rdata")
part = "part"
brains_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = "brains", part = "part")
dim(brains_out)[1]==dim(DF)[1]

brains_out = merge(brains_out, dist)
save(brains_out,file =  "brains_out.Rdata")
# T$brain_body_weight = T$BrainWeight/T$BodyWeight#don't need to do this because it already has EncCoeff
# source("brains_scratch.R")=
```

##country: multiple rows per species; for example:
```{r country, include = FALSE}
load("DF.Rdata")
test = data.frame(country(DF$Species[1]))  
head(test)
```
## countrysub -- multiple rows per species
##https://www.fishbase.de/manual/english/FishBaseThe_Countries_Table.htm
```{r, include = FALSE}
load("DF.Rdata")
test = data.frame(countrysub(DF$Species[1]))  
head(test)
```


##get ecology data
##http://fishbase.us/manual/English/FishbaseThe_ECOLOGY_Table.htm
```{r ecology, include = FALSE}
T<- ecology()

load("DF.Rdata")
load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")

# save(T, file="T_ecology.Rdata")
# load("T_ecology.Rdata")
load("non_biological.Rdata")
# source("ecology_scratch.R")
#part = part to just do the haddock scored species
ecology = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = "ecology", part = "part")

str_which(names(ecology),"Species")

dim(ecology)[1]==dim(DF)[1]#check this is true

save(ecology, file = "ecology.Rdata")

load("brains_out.Rdata")
out = brains_out
dim(ecology)[1]==dim(brains_out)[1]
length(str_which(names(ecology),"Species"))
length(str_which(names(brains_out),"Species"))

table_out = ecology
sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])

# out = merge(ecology, brains_out) 
save(out, file = "out.Rdata")

length(str_which(names(out),"Species"))

```

##distribution
##currently this is ~ FAO areas table (minus "note" field) e.g. http://www.fishbase.us/Country/FaoAreaList.php?ID=5537
##each species may have multiple bounding boxes
```{r distribution, include = FALSE}
rm(table_out)
table_name = "distribution"
T<-distribution()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

T_n <- T %>%  select_if(is.numeric)
summary(T_n)

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```



##ecosystem -- couldn't find description of this online
##multiple rows per species, one for each ecosystem
```{r ecosystem, include = FALSE}
load("ecology.Rdata")
DF = ecology

species = DF$Species
out = NULL

for (a in 1:length(species)){
  tmp = data.frame(ecosystem(species[a]))
  print(dim(tmp)[1])
  out = rbind(out, tmp)
}

summary(out)
head(tmp)

```

##estimate: a table of estimates from some models on trophic levels
##http://www.fishbase.us/manual/English/FishbaseThe_FOOD_ITEMS_table.htm
```{r estimate, include = FALSE}
rm(table_out)
table_name = "estimate"
T<- estimate()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
# source("ecology_scratch.R")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])

# out = merge(table_out, out) 
save(out, file = "out.Rdata")
save(out, file = paste0("out", "_", table_name, ".Rdata"))
length(str_which(names(out),"Species"))


summary(out)

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])
```

##faoareas, seems to be redundant to countrysub? 
```{r, include = FALSE}
test = faoareas(species_list = species[a])
test
```

##fecundity
##sometimes multiple rows per species. could not 
##could not locate doc table about fecundity. spawning table seems to be something different (different fields): https://www.fishbase.in/manual/fishbasethe_spawning_table.htm
```{r fecundity, include = FALSE}
rm(table_out)
table_name = "fecundity"
T<- fecundity()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
# source("ecology_scratch.R")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])

# out = merge(table_out, out) 
length(str_which(names(out),"Species"))
names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")
save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##fooditems -- including this one
##http://www.fishbase.org/manual/english/fishbasethe_food_items_table.htm
##multiple rows per species, for different food types, life stages of predator, locality, etc. 
```{r fooditems, include = FALSE}
rm(table_out)
table_name = "fooditems"
T<- fooditems()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
# source("ecology_scratch.R")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

load("out_fooditems.Rdata")
```

##genetic -- don't think we want to use this, but including just to see what it shows
```{r, include = FALSE}
# load("DF_fooditems.Rdata")
# DF= DF_estimate
# 
# test = data.frame(genetics(DF$Species[1]))
# names(test)

```


##introductions -- species introductions data. for now making one new feature: the number of records about introductions; it seems that each row is a different place
##https://www.fishbase.in/manual/fishbasethe_introduction_table.htm
```{r introdoctions, include = FALSE}

rm(table_out)
table_name = "introductions"
T<- introductions()

# T$Estabwild = tolower(T$Estabwild)#added tolower to function

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))


# #simplify into two categories: yes or no
# no = c("not established", "probably not established", "probably no", "probably no", "no")
# yes = c("established", "probably established", "yes", "probably yes")
# 
# Estabwild_binary=rep(NA, dim(F_f1)[1])
# 
# inds = which(F_f1$Estabwild %in% no)
# Estabwild_binary[inds] = 0
# 
# inds = which(F_f1$Estabwild %in% yes)
# Estabwild_binary[inds] = 1
# 
# F_f1$Estabwild_binary = Estabwild_binary

# F_f1$Estabwild_binary = factor(F_f1$Estabwild_binary)

# F_f1 = F_f1[, c("Species", "Estabwild_binary")]
# # F_f1 = subset(F_f1, Species == "Cyprinus carpio")
# F_sum <- F_f1 %>% 
#   drop_na(Estabwild_binary) %>% 
#   # na.omit() %>%#didn't work 
# 
#   group_by(Species) %>%
#   summarize(Estabwild_binary_mean = mean(Estabwild_binary))

```

##larvae
##https://www.fishbase.in/manual/fishbasethe_larvae_table.htm
##2 out of the 74 species have multiple records w/ different values. excluding for now. 
```{r, include = FALSE}
load("DF_intro.Rdata")
DF= DF_intro

species = DF$Species
for (a in 1:length(species)){
  tmp = data.frame(larvae(species_list = DF$Species[a]))
  # print(a)
  print(dim(tmp)[1])
}
#see what the other fields are

names(tmp)
#look at one that has multiple rows
a = 15
tmp = data.frame(larvae(species_list = DF$Species[a]))

head(tmp)

```

##length_freq; multiple records for some species; excluding for now; could not find metadata
```{r, include = FALSE}
load("DF_intro.Rdata")
DF= DF_intro
a = 15
species = DF$Species
for (a in 1:length(species)){
  tmp = data.frame(length_freq(species_list = DF$Species[a]))
  # print(a)
  print(dim(tmp)[1])
}
#see what the other fields are
names(tmp)
head(tmp)

```


##length_length: conversion of length types

##length_weight: The LENGTH-WEIGHT table presents the a and b values of over 5,000 length-weight relationships of the form W = a x Lb, pertaining to about over 2,000 fish species.
##multiple records for some species.
##seems like this may only be useful in combination with length_length
##https://www.fishbase.de/manual/FishbaseThe_LENGTH_WEIGHT_Table.htm
```{r, include = FALSE}
#"Length1"
T = length_weight()

length(which(is.na(T$Type)))#mostly this is empty

table(T$LmaxCompare)

table(T$Type)

#see what's in this table
T = length_length()
table(T$Length1)#different types of length measures

table(T$Length2)#different types of length measures
#can't tell which length type is being measured

table(T$Type)#mostly this is empty

rm(table_out)
T = length_weight()

#can't take out these rows because it will remove species we need
# ok = NULL
# ok = c(ok, which(is.na(T$Type)))#assume if it's empty it's standard
# ok = c(ok, which(T$Type == "SL"))
# T = T[ok,]

ok = NULL
ok = c(ok, which(is.na(T$Type)))#assume if it's empty it's standard
ok = c(ok, which(T$Type == "SL"))
T$LengthMax[-ok]=NA
T$LengthMin[-ok]=NA

table_name = "length_weight"

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##maturity
##multiple records for some species, would need to take averages if we wanted to use. there are multiple measures of maturity to choose from.
##https://www.fishbase.in/manual/fishbasethe_maturity_table.htm
```{r maturity, include = FALSE}
load("DF_intro.Rdata")
DF= DF_intro

F <- maturity()

F[sapply(F, is.character)] <- lapply(F[sapply(F, is.character)], 
                                       as.factor)
F_f <- F %>%  select_if(is.factor) 

names(F_f)#none relevant

F_n <- F %>%  select_if(is.numeric) 

names(F_n)
species = DF$Species
for (a in 1:length(species)){
  tmp = data.frame(maturity(species_list = DF$Species[a]))
  # print(a)
  print(dim(tmp)[1])
}
#see what the other fields are
names(tmp)
a = 2
  tmp = data.frame(maturity(species_list = DF$Species[a]))
  head(tmp)

```

##morphology
##https://www.fishbase.in/manual/fishbasethe_morphology_table.htm
##there are multiple records for some species. 
```{r morphology, include = FALSE}
rm(table_out)
table_name = "morphology"
T<-morphology()


load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))
```


##morphometrics
##there are multiple records for some species; to include we would need to take averages
##exclude for now because couldn't find documentation
```{r, include = FALSE}
rm(table_out)
table_name = "morphometrics"
T<-morphometrics()
names(T)

```

##oxygen
##https://www.fishbase.in/manual/fishbasethe_oxygen_table.htm
##there are multiple records for some species (e.g. for different sexes); to include we would need to take averages
##include along with potentially influencing variables -- e.g. salinity, temp, swimming speed, etc. 
```{r oxygen, include = FALSE}

rm(table_out)
table_name = "oxygen"
T<-oxygen()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

load("out_oxygen.Rdata")

```

##popchar: Table of maximum length (Lmax), weight (Wmax) and age (tmax)
##https://www.fishbase.in/manual/fishbasethe_popchar_table.htm
##there are multiple records for some species; to include we would need to take averages
##
```{r popchar, include = FALSE}
rm(table_out)
table_name = "popchar"
T<-popchar()
unique(T$Type)#can't tell what this means
keep = setdiff(names(T), "Type")
T = T[,keep]
unique(T$TypeWeight)

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##popgrowth
##https://www.fishbase.in/manual/fishbasethe_popgrowth_table.htm
##multiple records for some species, e.g. for different sexes; 
```{r popgrowth, include = FALSE}
rm(table_out)
table_name = "popgrowth"
T<-popgrowth()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))


```

##popqb
##https://www.fishbase.se/manual/english/fishbasethe_popqb_table.htm
##population-based estimates of food consumption (i.e., estimates that account for the age structure of populations)
##multiple responses for some species. here there are two measures, popqb and maintenance qb. 
```{r popqb, include = FALSE}
rm(table_out)
table_name = "popqb"
T<-popqb()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##predators
##https://www.fishbase.se/manual/English/fishbasethe_predators_table.htm
```{r predators, include = FALSE}
load("DF.Rdata")
species = DF$Species
DF$predator_mammals = NA
for (a in 1:length(species)){
  tmp = data.frame(predators(species_list = DF$Species[a]))
  tmp = subset(tmp, !is.na(PredatorI))
  if (dim(tmp)[1]>0){
      DF$predator_count[a] = dim(tmp)[1]
      tmp_mammal = subset(tmp, PredatorI == "mammals")
      DF$predator_mammals[a]= dim(tmp_mammal)[1]    
  }
  # out = rbind(out, tmp)
}
# DF = out
save(DF, file = "DF.Rdata")

rm(table_out)
table_name = "predators"
T<-predators()

#from this one removing PreyStage
# ind_rm = which(names(T)=="PreyStage")
load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")

table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")
DF = DF[,c("Species", "predator_mammals")]
out = merge(out, DF, by = "Species")
dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##ration
##�ration� (Rd) pertains to an estimate of daily food consumption by fish of a specific size
##https://www.fishbase.in/manual/fishbasethe_ration_table.htm
##multiple rows for some species
```{r ration, include = FALSE}
rm(table_out)
table_name = "ration"
T<-ration()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

T<-ration()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))


```

##reproduction
##https://www.fishbase.in/manual/fishbasethe_reproduction_table.htm
##only one row per species for these HADDOCK species; adding these fields
```{r reporoduction, include = FALSE}
rm(table_out)
table_name = "reproduction"
T<-reproduction()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

# T<-ration()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##spawning
##https://www.fishbase.in/manual/fishbasethe_spawning_table.htm
##multiple rows per species, for different localities
```{r spawning, include = FALSE}
rm(table_out)
table_name = "spawning"
T<-spawning()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

# T<-ration()

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```

##speed
##https://www.fishbase.se/manual/English/PDF/FB_Book_ATorres_Swimming_Speed_RF_JG.pdf
##https://www.fishbase.in/manual/fishbasethe_swimming_and_speed_tables.htm
##multiple records for some species
```{r speed, include = FALSE}

rm(table_out)
table_name = "speed"
T<-speed()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

# T = subset(T, Reliable != "questionable")

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))


```

##stocks
##https://www.fishbase.in/manual/fishbasethe_stocks_table.htm
##multiple records for some species, one for each stock
```{r stocks, include = FALSE}

rm(table_out)
table_name = "stocks"
T<-stocks()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

# T = subset(T, Reliable != "questionable")

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")

#separately add these fields that might show up in other tables:
stocks_fields_exclude =c("Ecology" ,   "Abnorm", "Metabolism", "Predators" ,"Spawning",  "Fecundity",   "Speed",       "Diet"  , "Eggs"  , "EggDevel","Food",
  
  "Larvae",    "LarvDyn",    "LarvSpeed",  "PopDyn",    "Gillarea",   "Maturity",  "MatSizes",
  
  "Processing", "Reproduction" ,"Introductions" ,"Abundance" ,"Vision"  ,  "Genetics"  ,
  
  "CountryComp" ,"Allele",    "GeneticStudies" ,"Ration"    ,  "Foods",   "Ecotoxicology", "Brains",
  
  "Catches" ,  "FAOAqua")
non_biological = c(non_biological, stocks_fields_exclude)

table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))


```


##diet
##https://www.fishbase.in/manual/fishbasethe_diet_table.htm
##has multiple rows for different stages
```{r diet_table, include = FALSE}

rm(table_out)
table_name = "diet"
T<-diet()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")

non_biological = c(non_biological, stocks_fields_exclude)

table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))

```



##diet_items -- multiple rows per species. seems to be linked with DietCode to diet table
##https://www.fishbase.se/manual/English/fishbasethe_food_items_table.htm
```{r diet_items, include = FALSE}

# rm(table_out)
# table_name = "diet_items"
# T<-diet_items()
# 
# #check out fields
# T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
#                                        as.factor)
# T_f <- T %>%  select_if(is.factor)
# summary(T_f)
# 
# load("DF.Rdata")
# 
# load("process_table.Rdata")
# load("sum_or_mean.Rdata")
# load("keep_real_binary.Rdata")
# load("non_biological.Rdata")
# 
# non_biological = c(non_biological, stocks_fields_exclude)
# 
# table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
# dim(table_out)[1]==dim(DF)[1]#check this is true
# 
# save(table_out, file =paste0(table_name, ".Rdata"))
# 
# str_which(names(table_out),"Species")
# 
# load("out.Rdata")
# 
# dim(table_out)[1]==dim(out)[1]
# 
# sp_ind = which(names(table_out)=="Species")
# out = cbind(out, table_out[,-sp_ind])
# length(str_which(names(out),"Species"))
# 
# names(out)[str_which(names(out),table_name)]
# summary(out[,str_which(names(out),table_name)])
# 
# save(out, file = "out.Rdata")
# 
# save(out, file = paste0("out", "_", table_name, ".Rdata"))

```



##swimming
##https://www.fishbase.in/manual/fishbasethe_swimming_and_speed_tables.htm
##one record per species
```{r swimming, include = FALSE}
rm(table_out)
table_name = "swimming"
T<-swimming()

#check out fields
T[sapply(T, is.character)] <- lapply(T[sapply(T, is.character)], 
                                       as.factor)
T_f <- T %>%  select_if(is.factor)
summary(T_f)

# T = subset(T, Reliable != "questionable")

load("DF.Rdata")

load("process_table.Rdata")
load("sum_or_mean.Rdata")
load("keep_real_binary.Rdata")
load("non_biological.Rdata")
non_biological = setdiff(non_biological, "Type")#put this one back in
threshold_frac = 0
table_out = process_table(T = T, DF = DF,exclude = non_biological, threshold_frac= 0,table_name = table_name, part = "part")
dim(table_out)[1]==dim(DF)[1]#check this is true

save(table_out, file =paste0(table_name, ".Rdata"))

str_which(names(table_out),"Species")

load("out.Rdata")

dim(table_out)[1]==dim(out)[1]

sp_ind = which(names(table_out)=="Species")
out = cbind(out, table_out[,-sp_ind])
length(str_which(names(out),"Species"))

names(out)[str_which(names(out),table_name)]
summary(out[,str_which(names(out),table_name)])

save(out, file = "out.Rdata")

save(out, file = paste0("out", "_", table_name, ".Rdata"))


fishbase_HADDOCK = out
write.csv(fishbase_HADDOCK, file = "fishbase_HADDOCK.csv")
```

##see what coverage is
```{r, include = FALSE}

load("out.Rdata")
save(out, file = "out_allfields.Rdata")
df = out
name_ct = length(names(df))
row_ct = dim(df)[1]
non_na_frac = rep(NA, name_ct)
for (a in 1:name_ct){
  non_na_frac[a]= length(which(!is.na(df[,a])))/ row_ct  
}
  

ok_cols = which(non_na_frac > cutoff)
DF_fields = data.frame(field = names(df),
                       non_na_frac = non_na_frac)
i = sort.int(DF_fields$non_na_frac,  index.return = TRUE, decreasing = TRUE)

DF_fields = DF_fields[i$ix,]
DF_fields

plot <- ggplot(data = DF_fields, aes(x = non_na_frac))+
  geom_histogram()+
  xlab("coverage within field")
plot
ggsave(plot, filename = "coverage.jpg")

h = hist(DF_fields$non_na_frac, plot = FALSE, breaks = 20)

```

##remove fields with 0 coverage
```{r, include = FALSE}
DF_fields_rm = subset(DF_fields, non_na_frac < cutoff)

names_rm = DF_fields_rm$field
names_rm#the fields to remove
print(DF_fields_rm[str_which(names_rm, "oxygen"),])

keep = setdiff(names(out), names_rm)
out = out[, keep]
dim(out)
save(out, file = "out.Rdata")
```

##add back haddock fields
```{r, include = FALSE}
load("out.Rdata")
save(out, file = "out_minus_haddock.Rdata")
load("DF.Rdata")
names_in_common = intersect(names(out), names(DF))
names_in_common = setdiff(names_in_common, "Species")
inds = which(names(DF) %in% names_in_common)
DF = DF[, -inds]
out = merge(out, DF, by = "Species")

rm = c("haddock_score_sd", "Species_ACE2")
keep = setdiff(names(out), rm)
out = out[, keep]
# dummify the data
Species = out$Species
# sp_ind = which(names(out)=="Species")
# dmy <- dummyVars(" ~ .", data = out[,-sp_ind])
# out <- data.frame(predict(dmy, newdata = out))
# out$Species = Species


save(out, file = "out.Rdata")
```


##remove fields with near-zero variation
```{r, include = FALSE}
load("out.Rdata")
DF = out

##remove variables with zero variation
sp_ind = which(names(DF)=="Species")
nzv = nearZeroVar(DF, freqCut = 95/5, saveMetrics = TRUE)
okay_inds = which(nzv$nzv == FALSE)
# length(okay_inds)
# okay_inds =c(okay_inds, sp_ind)
length(okay_inds)
DF = DF[,okay_inds]#include only the columns that have variation

fishbase_HADDOCK_biological = DF
save(fishbase_HADDOCK_biological, file = "fishbase_HADDOCK_biological.Rdata")
write.csv(fishbase_HADDOCK_biological, file = "fishbase_HADDOCK_biological.csv", row.names = FALSE)
```

##look for fields in common with other taxa that are not fish and output to add to datasets from other verts
```{r, include = FALSE}
source("compare_fields.R")
```

##add field with AA position 30
```{r, include = FALSE}
A <- read.csv("promal3d_30_83.csv")

AA_30_positive = rep(0, dim(A)[1])
i_blank = str_which(A$X, "-")
AA_30_positive[i_blank]=NA

i_pos = which(A$X %in% c("d", "e"))
AA_30_positive[i_pos] = 1
A$AA_30_positive = AA_30_positive

ACE2 = read.csv("ACE2_sequences_fixed.csv")
#which(ACE2$Species =="Astatotilapia burtoni")

intersect(A$Parsed.325.sequences,ACE2$AccessionNumProtein)

names(A)[names(A) == "Parsed.325.sequences"]= "AccessionNumProtein"
A = merge(A, ACE2)

names(A)[names(A)=="X"]="AA30"

names(A)[names(A)=="X.1"]="AA83"

DF = read.csv("docking-results.csv")

DF$species = str_replace(DF$species, pattern = "_", replacement = " ")

DF$species=capitalize(DF$species)

names(DF)[names(DF)=="species"]="Species"
A = merge(A, DF)
#rename field to merge

write.csv(A, file = "docking_results_AA_30_83.csv")
# glm(haddock_score_mean ~ AA_30_positive, family=binomial, data=A)
```

##add AA value to rest of fishbase data
```{r, include = FALSE}
A <- read.csv("docking_results_AA_30_83.csv")

keep = c("Species", "AA_30_positive", "Order", "Class")

A = A[,keep]
Species = A$Species
sp_ind = which(names(A)=="Species")
dmy <- dummyVars(" ~ .", data = A[,-sp_ind])
A <- data.frame(predict(dmy, newdata = A))
A$Species = Species

load("fishbase_HADDOCK_biological.Rdata")

DF = fishbase_HADDOCK_biological
dim(DF)
dim(A)
DF_m = merge(DF, A, by = "Species")
dim(DF_m)#lose two species
setdiff(DF$Species, DF_m$Species)

DF = DF_m

write.csv(names(DF), file = "names_fishbase.csv")

rm = NULL
rm = c(rm, str_which(names(DF), "record_count"))
rm = c(rm, "LengthMin_length_weight" ,"LengthMax_length_weight", "Weight_oxygen")
keep = setdiff(names(DF), rm)
DF = DF[,keep]

save(DF, file = "DF_fish.Rdata")
```


##remove fields with near-zero variation again
```{r, include = FALSE}
load("DF_fish.Rdata")

##remove variables with zero variation
sp_ind = which(names(DF)=="Species")
nzv = nearZeroVar(DF, freqCut = 95/5, saveMetrics = TRUE)
okay_inds = which(nzv$nzv == FALSE)
length(okay_inds)
DF = DF[,okay_inds]#include only the columns that have variation

save(DF, file = "DF_fish.Rdata")
```

##set up function gridSearch.R
```{r, include = FALSE}
source("gridSearch.R")
```

##combine data Adrian made with rest of fields from fish
```{r, include = FALSE}
V <- read.csv("verttraits_30072020_continuousforage.csv")
str_which(names(V), "brain")#nope
str_which(names(V), "habitat")#nope
str_which(names(V), "diet")#nope
str_which(names(V), "length")#nope

F <- read.csv("fishbase_haddock_vert 2.csv")#check what I'd shared with Adrian before
names(F)  

intersect(names(V), names(F))

intersect(V$Species, F$Species)#check that this is okay

load("DF_fish.Rdata")
F = DF

summary(V$log_adult_body_mass_g)
summary(V$adult_svl_cm)
names(F)[str_which(names(F), "length")]
#need to add these for fish
ufish = unique(F$Species)
for (a in 1:length(ufish)){
  v_ind = which(V$Species == ufish[a])#find index of fish in verts
  F_tmp = subset(F, Species == ufish[a])#find temp records for this fish
  V$log_adult_body_mass_g[v_ind] = log(F_tmp$BodyWeight_brains)
  V$adult_svl_cm[v_ind] = F_tmp$LengthAve_length_weight
}
summary(V$log_adult_body_mass_g)
summary(V$adult_svl_cm)
save(V, file = "V.Rdata")
write.csv(V, file = "verttraits_30072020_continuousforage_v2.csv")
```


##add AA value to rest of vert data
```{r, include = FALSE}
A <- read.csv("docking_results_AA_30_83.csv")

keep = c("Species", "AA_30_positive", "Order", "Class")

A = A[,keep]
Species = A$Species
sp_ind = which(names(A)=="Species")
dmy <- dummyVars(" ~ .", data = A[,-sp_ind])
A <- data.frame(predict(dmy, newdata = A))
A$Species = Species

load("V.Rdata")
DF = V
dim(DF)
dim(A)
DF_m = merge(DF, A, by = "Species")
dim(DF_m)#lose two species
print("these species we have trait data on for vertebrates but not for AA")

setdiff(DF$Species, DF_m$Species)

DF = DF_m


rm = NULL
rm = c(rm, str_which(names(DF), "record_count"))
rm = c(rm, "LengthMin_length_weight" ,"LengthMax_length_weight", "Weight_oxygen")
keep = setdiff(names(DF), rm)
DF = DF[,keep]
V = DF
save(V, file = "V.Rdata")
```

##remove order
```{r order_rm, include = FALSE}

load("V.Rdata")
#let's remove the Order fields, because they are many!
rm = str_which(names(V), "Order")
names(V)[rm]
keep = setdiff(names(V), "Order")
V = V[,keep]
save(V, file = "V.Rdata")

```

#make and use function for getting hits from fulltext from plos
```{r}
get_hits_fulltext <- function(search_terms){
  out = rep(NA, length(search_terms))
  for (a in 1:length(search_terms)){
    tmp = ft_search(query = search_terms[a], from = "plos")#get the search results across only PLOS because otherwise hit rate limits 
    out[a] = tmp$plos$found
    Sys.sleep(1)
  }
  out
}

load("V.Rdata")
search_terms = V$Species
out <- get_hits_fulltext(search_terms)
out = data.frame(hits = out,
                 Species = search_terms)
vert_haddock_plos = out
V = merge(V, vert_haddock_plos, by = "Species")
save(V, file = "V.Rdata")
save(vert_haddock_plos, file = "vert_haddock_plos.Rdata")
```

##use function gridSearch with all verts. output: "haddock_vert_for_gbm.csv"
```{r gridSearch_verts_median}
print(Sys.time())
load("gridSearch.Rdata")
output_name = "vert_haddock_20200803_2142"
cores = 4
  cl <- makeCluster(cores, "SOCK", timeout = 60)
  # stopCluster(cl)
  registerDoSNOW(cl)
load("V.Rdata")

out = V
Species = out$V
sp_ind = which(names(out)=="Species")
dmy <- dummyVars(" ~ .", data = out[,-sp_ind])
out <- data.frame(predict(dmy, newdata = out))
out$Species = Species
V = out

names = names(V)
DF = V
##remove variables with zero variation
sp_ind = which(names(DF)=="Species")
nzv = nearZeroVar(DF, freqCut = 95/5, saveMetrics = TRUE)
okay_inds = which(nzv$nzv == FALSE)
length(okay_inds)
DF = DF[,okay_inds]#include only the columns that have variation

T = DF
names = names(T)
binary = NULL
  for (a in 1:length(names)){
    vals = unique(T[,names[a]])
    vals = vals[!is.na(vals)]
    if (length(which(vals==0)) + length(which(vals == -1)) == 2){
      T[,names[a]]=factor(T[,names[a]])
      binary = c(binary, names[a])
      #change to 1 and 0
    }
  }
V = T

V$adult_svl_cm[is.nan(V$adult_svl_cm)] <- NA
V$log_adult_body_mass_g[is.nan(V$log_adult_body_mass_g)] <- NA

DF = V
# A<- read.csv(file = "docking_results_AA_30_83.csv")
#find out what haddock_score_median is across all species
haddock_median = median(V$haddock_score_mean)

above_haddock_median = rep(0, dim(DF)[1])
inds = which(DF$haddock_score_mean > haddock_median)
above_haddock_median[inds]= 1
DF$above_haddock_median = above_haddock_median
label = "above_haddock_median"

write.csv(DF, file = "haddock_vert_for_gbm.csv")
rm = which(names(DF) %in% c("haddock_score_mean", "Order", "Species", "nchar", "haddock_score_sd"))

DF = DF[,-rm]

#testing out
eta = c(0.0001)
max_depth = c(3)
n.minobsinnode = c(2)
nrounds = 100000

#for real
eta = c(0.0001, 0.001, 0.01, 0.1)
max_depth = c(2,3,4)
n.minobsinnode = c(2,5)
nrounds = 100000

# n.minobsinnode = c(2)
k_split = 0.8
distribution = "bernoulli"

label_col_ind = which(names(DF)==label)
x_col = seq(1:dim(DF)[2])
x_col = setdiff(x_col, label_col_ind)
vars = colnames(DF)[x_col]


GRID <- gridSearch(DF = DF, label = label, vars = vars, k_split = k_split, 
                         distribution = distribution, 
                         eta = eta, 
                         max_depth = max_depth, 
                         n.minobsinnode = n.minobsinnode,
                         nrounds = nrounds, 
                         method = "cv", 
                         cv.folds = 5)

hyper_grid = GRID[[1]]
# print(hyper_grid)
dev <- GRID[[2]]
save(GRID, file = paste0("GRID", ".", output_name, ".Rdata"))
save(hyper_grid, file = paste0("hyper_grid", ".", output_name, ".Rdata"))
print(Sys.time())

```

##make deviance plots
```{r dev_all}
PLTS <-lapply(1:length(unique(GRID[[2]]$group)), function(i) GRID[[2]] %>% filter(group == unique(GRID[[2]]$group)[i]) %>% ggplot() +
  geom_line(aes(x = index, y = train), color = "black", size = 1) +
  geom_line(aes(x = index, y = valid), color = "green", size = 1) +
    geom_vline(xintercept = GRID[[2]] %>% filter(group == unique(GRID[[2]]$group)[i]) %>% dplyr::select(best.iter) %>% unique %>% as.numeric, color = "blue", linetype = "dashed", size = 1) +
  labs(x = "Iteration", y = "Bernoulli deviance", title = unique(GRID[[2]]$group[i])) +
  theme(panel.background = element_blank(), panel.border = element_rect(fill = "transparent", color = "black", size = 1), panel.grid.major = element_line(color = "grey90")))

patchwork::wrap_plots(PLTS)
# , nrow = length(PLTS), heights= 5
save(PLTS, file = paste0("PLTS", ".", "deviance.", output_name, ".Rdata"))
```

##find out what happens if we set no lower limit on number of trees
```{r}
min_trees = 0
buffer= nrounds*0.33#buffer to make sure there are enough rounds when it comes to making null model
max_trees = nrounds - buffer
hyper_grid = GRID[[1]]
hyper_grid = subset(hyper_grid, n.trees < (max_trees))#make sure the best iteration was reached before we ran out of trees
hyper_grid = subset(hyper_grid, n.trees >=min_trees)
hyper_grid = subset(hyper_grid, eval_test == max(hyper_grid$eval_test)) 
hyper_grid = subset(hyper_grid, eval_train == min(hyper_grid$eval_train))#take the one with the lowest train

DEV = GRID[[2]]
DEV = subset(DEV, group == hyper_grid$group)#get just this winning set of hyperparameters
GRID[[2]]=DEV

PLTS <-lapply(1:length(unique(GRID[[2]]$group)), function(i) GRID[[2]] %>% filter(group == unique(GRID[[2]]$group)[i]) %>% ggplot() +
  geom_line(aes(x = index, y = train), color = "black", size = 1) +
  geom_line(aes(x = index, y = valid), color = "green", size = 1) +
    geom_vline(xintercept = GRID[[2]] %>% filter(group == unique(GRID[[2]]$group)[i]) %>% dplyr::select(best.iter) %>% unique %>% as.numeric, color = "blue", linetype = "dashed", size = 1) +
  labs(x = "Iteration", y = "Bernoulli deviance", title = unique(GRID[[2]]$group[i])) +
  theme(panel.background = element_blank(), panel.border = element_rect(fill = "transparent", color = "black", size = 1), panel.grid.major = element_line(color = "grey90")))

patchwork::wrap_plots(PLTS)
# , nrow = length(PLTS), heights= 5
save(PLTS, file = paste0("PLTS", ".", "deviance.best.no.lower", output_name, ".Rdata"))

```


##make deviance plot just for the "best" parameters requiring at least 10000 trees as optimal number of trees
```{r dev_best}

load(paste0("GRID", ".", output_name, ".Rdata"))
min_trees = 10000
hyper_grid = GRID[[1]]
buffer= nrounds*0.33#buffer to make sure there are enough rounds when it comes to making null model
max_trees = nrounds - buffer
hyper_grid = subset(hyper_grid, n.trees < (max_trees))#make sure the best iteration was reached before we ran out of trees
hyper_grid = subset(hyper_grid, n.trees >=min_trees)
hyper_grid = subset(hyper_grid, eval_test == max(hyper_grid$eval_test)) 
hyper_grid = subset(hyper_grid, eval_train == min(hyper_grid$eval_train))#take the one with the lowest train

DEV = GRID[[2]]
DEV = subset(DEV, group == hyper_grid$group)#get just this winning set of hyperparameters
GRID[[2]]=DEV

PLTS <-lapply(1:length(unique(GRID[[2]]$group)), function(i) GRID[[2]] %>% filter(group == unique(GRID[[2]]$group)[i]) %>% ggplot() +
  geom_line(aes(x = index, y = train), color = "black", size = 1) +
  geom_line(aes(x = index, y = valid), color = "green", size = 1) +
    geom_vline(xintercept = GRID[[2]] %>% filter(group == unique(GRID[[2]]$group)[i]) %>% dplyr::select(best.iter) %>% unique %>% as.numeric, color = "blue", linetype = "dashed", size = 1) +
  labs(x = "Iteration", y = "Bernoulli deviance", title = unique(GRID[[2]]$group[i])) +
  theme(panel.background = element_blank(), panel.border = element_rect(fill = "transparent", color = "black", size = 1), panel.grid.major = element_line(color = "grey90")))

patchwork::wrap_plots(PLTS)
# , nrow = length(PLTS), heights= 5
save(PLTS, file = paste0("PLTS", ".", "deviance.best.1000", output_name, ".Rdata"))


```


```{r bootstrapGBM}
source("bootstrapGBM.R")
```

#bootstrapGBM -- run with all vertebrates
```{r bootstrapGBM_vert_median}
print(Sys.time())

# nruns = 1

nruns = 10

OUT_obs <- bootstrapGBM(DF = DF, label = label, vars = vars, k_split = k_split, distribution = "bernoulli", eta = hyper_grid$eta, max_depth = hyper_grid$max_depth, nrounds = nrounds, nruns = nruns, bootstrap = "observed", method = "cv", cv.folds = 5,
                        n.minobsinnode = hyper_grid$n.minobsinnode,file_label=output_name)
bootstrap = "observed"
file_label = output_name

load(paste0(bootstrap, "hist_", file_label,".Rdata"))
# ,
#                         file_label=output_name
save(OUT_obs, file = paste0("OUT_observed_", output_name, ".Rdata"))

OUT_rand <- bootstrapGBM(DF = DF, label = label, vars = vars, k_split = k_split, distribution = "bernoulli", eta = hyper_grid$eta, max_depth = hyper_grid$max_depth, nrounds = nrounds, nruns = nruns, bootstrap = "null", method = "cv", cv.folds = 5,
                        n.minobsinnode = hyper_grid$n.minobsinnode, file_label = "null")

save(OUT_rand, file = paste0("OUT_rand_", output_name, ".Rdata"))

print(Sys.time())
```

##look at performance 
```{r perf}
I <- OUT_obs[[1]]

print("observed data, eval train")
mean(I$auc_train)
print("observed data, eval test")
mean(I$auc_test)

R <- OUT_rand[[1]]

mean(R$auc_train)
print("null data, eval test")
mean(R$auc_test)

```

##plot importance
```{r importance}
rm = c("eta", "max_depth", "n.trees", "auc_train", "auc_test")
keep = setdiff(names(I),rm)
I = I[,keep]

data_long <- gather(I, key = "var", value = "value", c(2:dim(I)[2]), factor_key=TRUE)

data_long_sum <- data_long %>% group_by(var) %>%
  summarize(mean_importance = mean(value))

data_long_sum_nonzero = subset(data_long_sum, mean_importance > 0)

data_long_nonzero = subset(data_long, var %in% data_long_sum_nonzero$var)

plot <- ggplot(data = data_long_nonzero, aes(x = reorder(var, -value), y = value))+
  geom_boxplot()+
  theme(panel.background = element_blank(), panel.border = element_rect(fill = NA, color = "black", size = 1), axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2), panel.grid.major.y = element_line(color = "grey80"), panel.grid.major.x = element_line(color = "transparent"))+
  xlab("variable")+
  ylab("importance")


plot

```


##partial_plotR.R -- define
```{r partial}
source("partial_plotR.R")
```

##use partial_plotR.R to make PD plots
##note this commented out for now, because getting error
```{r partial_run}
load(paste0(bootstrap, "hist_", file_label,".Rdata"))

# cut =12#choose some number so there aren't too many
# data_long_sum=data.frame(data_long_sum)
# data_long_sum = subset(data_long_sum, mean_importance >0 )
# sorted_inds = sort.int(data_long_sum$mean_importance, decreasing = TRUE, index.return = TRUE)
# 
# data_long_sum = data_long_sum[sorted_inds$ix,]
# 
# data_long_sum_low = data_long_sum[c(1:cut),]
# 
# inds_keep = which(out_hist$variable.name %in% data_long_sum_low$var)
# out_hist = out_hist[inds_keep,]
# vars_plot = data_long_sum_low$var#these are the vars we're keeping

hist.data = out_hist

pd_out = OUT_obs[[2]]
# pd_out = subset(pd_out, variable.name %in% vars_plot)
# partial_plot(data = DF, hist.data, vars, type = c("mean", "all"), histogram = T) 
# partial_plot(data = pd_out, hist.data = hist.data, vars = vars, type = "all", histogram = TRUE) 

```


